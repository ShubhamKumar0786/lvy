<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signal.vin Bulk Appraisal</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif; background-color: #0e1117; color: #fafafa; display: flex; min-height: 100vh; }
.sidebar { width: 300px; min-width: 300px; background-color: #262730; border-right: 1px solid #3d4051; overflow-y: auto; height: 100vh; position: fixed; left: 0; top: 0; }
.sidebar-content { padding: 1rem; }
.config-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #3d4051; }
.config-section h2 { font-size: 0.9rem; font-weight: 600; color: #fafafa; margin-bottom: 1rem; }
.form-group { margin-bottom: 0.75rem; }
.form-group label { display: block; font-size: 0.85rem; color: #b0b0b0; margin-bottom: 0.25rem; }
.form-group input[type="text"], .form-group input[type="password"] { width: 100%; padding: 0.5rem 0.75rem; background-color: #0e1117; border: 1px solid #3d4051; border-radius: 4px; color: #fafafa; font-size: 0.9rem; }
.form-group input:focus { outline: none; border-color: #ff4b4b; }
.form-row { display: flex; gap: 0.75rem; }
.form-group.half { flex: 1; }
.password-input { position: relative; display: flex; }
.password-input input { flex: 1; padding-right: 2.5rem; }
.toggle-password { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #b0b0b0; cursor: pointer; font-size: 1rem; }
.prefix-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem; }
.prefix-tag { padding: 0.25rem 0.75rem; background-color: #3d4051; border-radius: 4px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
.prefix-tag.active { background-color: #ff4b4b; color: white; }
.prefix-tag:hover { background-color: #4d5061; }
.prefix-tag.active:hover { background-color: #ff6b6b; }
.checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; }
.checkbox-label input[type="checkbox"] { width: 1rem; height: 1rem; accent-color: #ff4b4b; }
.main-content { flex: 1; margin-left: 300px; padding: 2rem; min-height: 100vh; }
.header { text-align: center; margin-bottom: 2rem; }
.header h1 { font-size: 2.5rem; font-weight: bold; background: linear-gradient(135deg, #ff4b4b 0%, #ff6b6b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
.header .subtitle { font-size: 1.1rem; color: #808495; }
.status-bar { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #262730; border-radius: 8px; margin-bottom: 1rem; }
.running-indicator { display: flex; align-items: center; gap: 0.5rem; color: #4caf50; }
.spinner { width: 1rem; height: 1rem; border: 2px solid #4caf50; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.stop-btn { padding: 0.25rem 0.75rem; background-color: #ff4b4b; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; }
.tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid #3d4051; padding-bottom: 0.5rem; }
.tab { padding: 0.5rem 1rem; background: none; border: none; color: #808495; font-size: 0.95rem; cursor: pointer; border-radius: 4px 4px 0 0; transition: all 0.2s; }
.tab:hover { color: #fafafa; background-color: rgba(255, 75, 75, 0.1); }
.tab.active { color: #ff4b4b; border-bottom: 2px solid #ff4b4b; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.tab-content h2 { font-size: 1.5rem; margin-bottom: 1.5rem; }
.button-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
.btn-primary, .btn-secondary { flex: 1; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.btn-primary:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); transform: translateY(-1px); }
.btn-primary.large { padding: 1rem 2rem; font-size: 1.1rem; width: 100%; margin-top: 1rem; }
.btn-secondary { background: linear-gradient(135deg, #ff4b4b 0%, #ff6b6b 100%); color: white; }
.btn-secondary:hover { background: linear-gradient(135deg, #ff6b6b 0%, #ff4b4b 100%); }
.status-message, .info-message, .success-message, .warning-message, .error-message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
.status-message.success, .success-message { background-color: rgba(76, 175, 80, 0.2); border: 1px solid #4caf50; color: #81c784; }
.status-message.error, .error-message { background-color: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; color: #e57373; }
.info-message { background-color: rgba(33, 150, 243, 0.2); border: 1px solid #2196f3; color: #64b5f6; }
.warning-message { background-color: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; color: #ffb74d; }
.expander-section { margin: 1rem 0; }
.expander { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #262730; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
.expander:hover { background-color: #363740; }
.expander-icon { transition: transform 0.2s; }
.expander-content { padding: 1rem; background-color: #1a1c24; border-radius: 0 0 8px 8px; margin-top: -4px; }
.expander-content.collapsed { display: none; }
.expander-content pre { background-color: #0e1117; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.85rem; color: #a0a0a0; white-space: pre-wrap; word-wrap: break-word; }
.metrics-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin: 1.5rem 0; }
.metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.25rem; border-radius: 10px; text-align: center; }
.metric-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
.metric-card.red { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
.metric-card.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.metric-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.metric-value { display: block; font-size: 1.75rem; font-weight: bold; color: white; }
.metric-label { display: block; font-size: 0.85rem; color: rgba(255, 255, 255, 0.9); margin-top: 0.25rem; }
.table-section { margin: 1.5rem 0; }
.table-section h3 { margin-bottom: 1rem; }
.table-container { max-height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid #3d4051; }
table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
thead { position: sticky; top: 0; background-color: #262730; }
th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #3d4051; }
th { font-weight: 600; color: #fafafa; }
td { color: #b0b0b0; }
tr:hover td { background-color: rgba(255, 75, 75, 0.05); }
td a { color: #64b5f6; text-decoration: none; }
td a:hover { text-decoration: underline; }
.progress-bar { width: 100%; height: 8px; background-color: #3d4051; border-radius: 4px; overflow: hidden; margin: 1rem 0; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease; }
.progress-text { text-align: center; color: #808495; font-size: 0.9rem; }
.logs-section { margin-top: 1.5rem; }
.logs-container { max-height: 400px; overflow-y: auto; background-color: #1a1c24; border-radius: 8px; padding: 1rem; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.85rem; }
.log-entry { padding: 0.5rem 0; border-bottom: 1px solid #262730; }
.log-entry:last-child { border-bottom: none; }
.log-entry.success { color: #81c784; }
.log-entry.error { color: #e57373; }
.log-entry.warning { color: #ffb74d; }
.log-entry.info { color: #64b5f6; }
.download-section { margin: 2rem 0; padding: 1.5rem; background-color: #262730; border-radius: 10px; }
.download-section h3 { margin-bottom: 1rem; }
.footer { text-align: center; padding: 2rem; color: #808495; font-size: 0.9rem; border-top: 1px solid #3d4051; margin-top: 2rem; }
.hidden { display: none !important; }
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #1a1c24; }
::-webkit-scrollbar-thumb { background: #3d4051; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #4d5061; }
@media (max-width: 1200px) { .metrics-section { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .sidebar { width: 100%; position: relative; height: auto; } .main-content { margin-left: 0; } body { flex-direction: column; } .metrics-section { grid-template-columns: 1fr; } .button-row { flex-direction: column; } }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-content">
            <div class="config-section">
                <h2>üìä Google Sheets URL</h2>
                <div class="form-group">
                    <label>Google Sheet URL (Public)</label>
                    <input type="text" id="googleSheetUrl" placeholder="Paste Google Sheet URL here...">
                    <small style="color: #808495; display: block; margin-top: 0.5rem;">Sheet must be publicly accessible</small>
                </div>
            </div>
            <div class="config-section">
                <h2>üîê Signal.vin Credentials</h2>
                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="signalEmail" value="bikram@dreamfleet.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-input">
                        <input type="password" id="signalPassword" value="Export@123">
                        <button class="toggle-password" onclick="togglePassword('signalPassword')">üëÅ</button>
                    </div>
                </div>
            </div>
            <div class="config-section">
                <h2>üìã Column Mapping</h2>
                <div class="form-row">
                    <div class="form-group half"><label>VIN Column</label><input type="text" id="vinColumn" value="vin"></div>
                    <div class="form-group half"><label>Trim Column</label><input type="text" id="trimColumn" value="trim"></div>
                </div>
                <div class="form-row">
                    <div class="form-group half"><label>Odometer Column</label><input type="text" id="odometerColumn" value="kilometers"></div>
                    <div class="form-group half"><label>Price Column</label><input type="text" id="priceColumn" value="price"></div>
                </div>
                <div class="form-group"><label>Listing URL Column</label><input type="text" id="urlColumn" value="listing_link"></div>
            </div>
            <div class="config-section">
                <h2>üî¢ VIN Prefixes</h2>
                <label>Valid Prefixes (North American)</label>
                <div class="prefix-tags">
                    <span class="prefix-tag active" data-prefix="1">1 √ó</span>
                    <span class="prefix-tag active" data-prefix="4">4 √ó</span>
                    <span class="prefix-tag active" data-prefix="5">5 √ó</span>
                    <span class="prefix-tag" data-prefix="2">2</span>
                    <span class="prefix-tag" data-prefix="3">3</span>
                </div>
            </div>
            <div class="config-section">
                <h2>üñ•Ô∏è Browser Settings</h2>
                <label class="checkbox-label"><input type="checkbox" id="headless" checked><span>Run in background (Headless)</span></label>
            </div>
        </div>
    </div>
    <div class="main-content">
        <div class="header">
            <h1>üöó Signal.vin Bulk Appraisal</h1>
            <p class="subtitle">Automated Export Value Calculator - Google Sheets Edition</p>
        </div>
        <div id="statusBar" class="status-bar hidden">
            <span id="statusText"></span>
            <span id="runningIndicator" class="running-indicator hidden">
                <span class="spinner"></span> RUNNING...
                <button onclick="stopProcessing()" class="stop-btn">Stop</button>
            </span>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="load-data">üì• Load Data</button>
            <button class="tab" data-tab="process-vins">üöÄ Process VINs</button>
            <button class="tab" data-tab="results">üìä Results</button>
        </div>
        <div id="load-data" class="tab-content active">
            <h2>Load Data from Google Sheets</h2>
            <div class="button-row">
                <button class="btn-primary" onclick="fetchData()">üîÑ Fetch Data from Google Sheets</button>
                <button class="btn-secondary" onclick="clearData()">üóëÔ∏è Clear Data</button>
            </div>
            <div id="loadStatus" class="status-message hidden"></div>
            <div id="metricsSection" class="metrics-section hidden">
                <div class="metric-card"><span class="metric-value" id="totalRows">0</span><span class="metric-label">Total Rows</span></div>
                <div class="metric-card green"><span class="metric-value" id="validVins">0</span><span class="metric-label">Valid VINs (1,4,5)</span></div>
                <div class="metric-card red"><span class="metric-value" id="skippedVins">0</span><span class="metric-label">Skipped VINs</span></div>
                <div class="metric-card purple"><span class="metric-value" id="prefixesDisplay">1, 4, 5</span><span class="metric-label">Prefixes</span></div>
            </div>
            <div id="validVinsSection" class="table-section hidden">
                <h3>üìã Valid VINs to Process</h3>
                <div class="table-container"><table id="validVinsTable"><thead><tr id="validVinsHeader"></tr></thead><tbody id="validVinsBody"></tbody></table></div>
            </div>
            <div id="skippedVinsSection" class="expander-section hidden">
                <div class="expander" onclick="toggleExpander(this)"><span>‚è≠Ô∏è Skipped VINs (click to expand)</span><span class="expander-icon">‚ñ∂</span></div>
                <div class="expander-content collapsed"><div class="table-container"><table id="skippedVinsTable"><thead><tr id="skippedVinsHeader"></tr></thead><tbody id="skippedVinsBody"></tbody></table></div></div>
            </div>
        </div>
        <div id="process-vins" class="tab-content">
            <h2>Process Vehicles</h2>
            <div id="noDataWarning" class="warning-message">‚ö†Ô∏è Please load data first from the 'Load Data' tab</div>
            <div id="processSection" class="hidden">
                <div class="info-message">üìã Ready to process <span id="readyCount">0</span> vehicles</div>
                <div class="success-message">‚úÖ Results will be returned as JSON file for download</div>
                <button class="btn-primary large" onclick="startProcessing()" id="startBtn">üöÄ Start Processing</button>
                <div id="progressSection" class="hidden">
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>
                <div id="logsSection" class="logs-section hidden">
                    <h3>üìù Processing Logs</h3>
                    <div id="logsContainer" class="logs-container"></div>
                </div>
            </div>
        </div>
        <div id="results" class="tab-content">
            <h2>Processing Results</h2>
            <div id="noResultsMessage" class="info-message">No results yet. Process some VINs first!</div>
            <div id="resultsContent" class="hidden">
                <div class="metrics-section">
                    <div class="metric-card green"><span class="metric-value" id="successCount">0</span><span class="metric-label">‚úÖ Success</span></div>
                    <div class="metric-card orange"><span class="metric-value" id="errorCount">0</span><span class="metric-label">‚ö†Ô∏è Errors</span></div>
                    <div class="metric-card purple"><span class="metric-value" id="totalProcessed">0</span><span class="metric-label">üìä Total Processed</span></div>
                </div>
                <div class="download-section">
                    <h3>üì• Download Results</h3>
                    <div class="button-row">
                        <button class="btn-primary" onclick="downloadJSON()">üìã Download JSON</button>
                        <button class="btn-secondary" onclick="downloadCSV()">üìÑ Download CSV</button>
                    </div>
                </div>
                <div id="resultsTableSection">
                    <h3>üìã All Results</h3>
                    <div class="table-container"><table id="resultsTable"><thead><tr><th>VIN</th><th>Odometer</th><th>Export Value (CAD)</th><th>Status</th></tr></thead><tbody id="resultsBody"></tbody></table></div>
                </div>
                <div id="jsonPreviewSection" class="expander-section">
                    <div class="expander" onclick="toggleExpander(this)"><span>üìÑ JSON Preview (click to expand)</span><span class="expander-icon">‚ñ∂</span></div>
                    <div class="expander-content collapsed"><pre id="jsonPreview"></pre></div>
                </div>
            </div>
        </div>
        <div class="footer">Signal.vin Bulk Appraisal Tool - Google Sheets Edition</div>
    </div>
<script>
let sheetData=null,validRows=[],results=[],isProcessing=false,eventSource=null;
function formatCurrency(a){return a>=0?`$${a.toLocaleString('en-US',{maximumFractionDigits:0})}`:`-$${Math.abs(a).toLocaleString('en-US',{maximumFractionDigits:0})}`}
function parsePrice(p){if(!p)return 0;return parseFloat(String(p).replace(/[^\d.-]/g,''))||0}
function getValidPrefixes(){let p=[];document.querySelectorAll('.prefix-tag.active').forEach(t=>p.push(t.dataset.prefix));return p}
function isValidVin(v,p){if(!v||v.length<17)return false;return p.some(x=>v.toUpperCase().startsWith(x))}
function togglePassword(i){let e=document.getElementById(i);e.type=e.type==='password'?'text':'password'}
function toggleExpander(e){let c=e.nextElementSibling,i=e.querySelector('.expander-icon');c.classList.contains('collapsed')?(c.classList.remove('collapsed'),i.textContent='‚ñº'):(c.classList.add('collapsed'),i.textContent='‚ñ∂')}
function parseGoogleSheetUrl(u){let p=[/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,/\/d\/([a-zA-Z0-9-_]+)/];for(let r of p){let m=u.match(r);if(m)return m[1]}return null}
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));t.classList.add('active');document.getElementById(t.dataset.tab).classList.add('active')}));
document.querySelectorAll('.prefix-tag').forEach(t=>t.addEventListener('click',()=>{t.classList.toggle('active');t.textContent=t.classList.contains('active')?t.dataset.prefix+' √ó':t.dataset.prefix;document.getElementById('prefixesDisplay').textContent=getValidPrefixes().join(', ')||'None';if(sheetData)filterAndDisplayData()}));
async function fetchData(){let u=document.getElementById('googleSheetUrl').value.trim();if(!u){alert('Please enter a Google Sheet URL');return}let id=parseGoogleSheetUrl(u);if(!id){alert('Invalid Google Sheet URL');return}let s=document.getElementById('loadStatus');s.classList.remove('hidden','success','error');s.textContent='‚è≥ Fetching...';s.className='status-message info-message';try{let r=await fetch(`https://docs.google.com/spreadsheets/d/${id}/export?format=csv`);if(!r.ok)throw new Error('Failed to fetch. Make sure sheet is public.');let t=await r.text();sheetData=parseCSV(t);if(sheetData.length===0)throw new Error('No data found');s.textContent=`‚úÖ Loaded ${sheetData.length} rows`;s.className='status-message success-message';filterAndDisplayData()}catch(e){s.textContent=`‚ùå Error: ${e.message}`;s.className='status-message error-message'}}
function parseCSV(t){let l=t.split('\n');if(l.length<2)return[];let h=parseCSVLine(l[0]),d=[];for(let i=1;i<l.length;i++){let ln=l[i].trim();if(!ln)continue;let v=parseCSVLine(ln),r={};h.forEach((x,j)=>r[x.trim().toLowerCase()]=v[j]||'');d.push(r)}return d}
function parseCSVLine(l){let r=[],c='',q=false;for(let i=0;i<l.length;i++){let ch=l[i];if(ch==='"'){if(q&&l[i+1]==='"'){c+='"';i++}else q=!q}else if(ch===','&&!q){r.push(c);c=''}else c+=ch}r.push(c);return r}
function filterAndDisplayData(){if(!sheetData)return;let vc=document.getElementById('vinColumn').value.toLowerCase(),p=getValidPrefixes(),cols=sheetData.length>0?Object.keys(sheetData[0]):[];validRows=[];let inv=[];sheetData.forEach(r=>{let v=String(r[vc]||'').trim().toUpperCase();isValidVin(v,p)?validRows.push(r):inv.push(r)});document.getElementById('metricsSection').classList.remove('hidden');document.getElementById('totalRows').textContent=sheetData.length;document.getElementById('validVins').textContent=validRows.length;document.getElementById('skippedVins').textContent=inv.length;document.getElementById('prefixesDisplay').textContent=p.join(', ')||'None';displayTable('validVinsSection','validVinsHeader','validVinsBody',validRows,cols);inv.length>0?(document.getElementById('skippedVinsSection').classList.remove('hidden'),displayTable('skippedVinsSection','skippedVinsHeader','skippedVinsBody',inv,cols)):document.getElementById('skippedVinsSection').classList.add('hidden');updateProcessTab()}
function displayTable(s,h,b,d,c){document.getElementById(s).classList.remove('hidden');document.getElementById(h).innerHTML=c.map(x=>`<th>${x}</th>`).join('');document.getElementById(b).innerHTML=d.map(r=>`<tr>${c.map(x=>`<td>${r[x]||''}</td>`).join('')}</tr>`).join('')}
function clearData(){sheetData=null;validRows=[];results=[];['loadStatus','metricsSection','validVinsSection','skippedVinsSection'].forEach(x=>document.getElementById(x).classList.add('hidden'));updateProcessTab();updateResultsTab()}
function updateProcessTab(){let n=document.getElementById('noDataWarning'),p=document.getElementById('processSection');!sheetData||validRows.length===0?(n.classList.remove('hidden'),p.classList.add('hidden')):(n.classList.add('hidden'),p.classList.remove('hidden'),document.getElementById('readyCount').textContent=validRows.length)}
async function startProcessing(){if(isProcessing||validRows.length===0){if(validRows.length===0)alert('No valid VINs!');return}isProcessing=true;results=[];let vc=document.getElementById('vinColumn').value.toLowerCase(),oc=document.getElementById('odometerColumn').value.toLowerCase(),tc=document.getElementById('trimColumn').value.toLowerCase(),pc=document.getElementById('priceColumn').value.toLowerCase(),uc=document.getElementById('urlColumn').value.toLowerCase();let cfg={signal_email:document.getElementById('signalEmail').value,signal_password:document.getElementById('signalPassword').value,headless:document.getElementById('headless').checked,valid_rows:validRows.map(r=>({vin:String(r[vc]||'').trim().toUpperCase(),odometer:String(r[oc]||'0').trim()||'0',trim:String(r[tc]||'').trim(),list_price:parsePrice(r[pc]),listing_url:String(r[uc]||'').trim(),carfax_link:String(r['carfax_link']||'').trim(),make:String(r['make']||'').trim(),model:String(r['model']||'').trim()}))};document.getElementById('progressSection').classList.remove('hidden');document.getElementById('logsSection').classList.remove('hidden');document.getElementById('startBtn').disabled=true;document.getElementById('runningIndicator').classList.remove('hidden');document.getElementById('logsContainer').innerHTML='';try{let res=await fetch('/api/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(cfg)});let rd=res.body.getReader(),dc=new TextDecoder();while(true){let{value,done}=await rd.read();if(done)break;let txt=dc.decode(value);txt.split('\n').filter(l=>l.startsWith('data: ')).forEach(l=>{try{handleProcessingUpdate(JSON.parse(l.substring(6)))}catch(e){}})}}catch(e){addLog(`‚ùå Error: ${e.message}`,'error')}finally{isProcessing=false;document.getElementById('startBtn').disabled=false;document.getElementById('runningIndicator').classList.add('hidden');updateResultsTab()}}
function handleProcessingUpdate(d){switch(d.type){case'progress':document.getElementById('progressFill').style.width=`${d.progress*100}%`;document.getElementById('progressText').textContent=d.message;break;case'log':addLog(d.message,d.level||'info');break;case'result':results.push(d.result);updateResultsTab();break;case'complete':addLog(`‚úÖ ${d.message}`,'success');document.getElementById('progressFill').style.width='100%';break;case'error':addLog(`‚ùå ${d.message}`,'error');break}}
function addLog(m,l='info'){let c=document.getElementById('logsContainer'),e=document.createElement('div');e.className=`log-entry ${l}`;e.innerHTML=m;c.appendChild(e);c.scrollTop=c.scrollHeight}
function stopProcessing(){if(eventSource)eventSource.close();fetch('/api/stop',{method:'POST'});isProcessing=false;document.getElementById('startBtn').disabled=false;document.getElementById('runningIndicator').classList.add('hidden');addLog('‚èπÔ∏è Stopped','warning')}
function updateResultsTab(){let n=document.getElementById('noResultsMessage'),c=document.getElementById('resultsContent');if(results.length===0){n.classList.remove('hidden');c.classList.add('hidden');return}n.classList.add('hidden');c.classList.remove('hidden');let s=results.filter(r=>r.export_value_cad),e=results.filter(r=>r.status==='ERROR'||r.status==='NO DATA');document.getElementById('successCount').textContent=s.length;document.getElementById('errorCount').textContent=e.length;document.getElementById('totalProcessed').textContent=results.length;document.getElementById('resultsBody').innerHTML=results.map(r=>`<tr><td>${r.vin}</td><td>${r.odometer}</td><td>${r.export_value_cad?formatCurrency(parseFloat(r.export_value_cad)):'N/A'}</td><td style="color:${r.export_value_cad?'#81c784':'#e57373'}">${r.status}</td></tr>`).join('');document.getElementById('jsonPreview').textContent=JSON.stringify(formatResultsAsJSON(),null,2)}
function formatResultsAsJSON(){return{generated_at:new Date().toISOString(),total_processed:results.length,successful:results.filter(r=>r.export_value_cad).length,errors:results.filter(r=>!r.export_value_cad).length,results:results.map(r=>({vin:r.vin,odometer:r.odometer,trim:r.signal_trim||r.trim||'',make:r.make||'',model:r.model||'',list_price:r.list_price||0,export_value_cad:r.export_value_cad?parseFloat(r.export_value_cad):null,profit:r.profit||null,status:r.status,listing_url:r.listing_url||'',carfax_link:r.carfax_link||''}))}}
function downloadJSON(){if(results.length===0){alert('No results!');return}downloadFile(JSON.stringify(formatResultsAsJSON(),null,2),`signal_vin_results_${getTimestamp()}.json`,'application/json')}
function downloadCSV(){if(results.length===0){alert('No results!');return}let h=['vin','odometer','trim','make','model','list_price','export_value_cad','profit','status','listing_url','carfax_link'],rows=results.map(r=>[r.vin,r.odometer,r.signal_trim||r.trim||'',r.make||'',r.model||'',r.list_price||0,r.export_value_cad||'',r.profit||'',r.status,r.listing_url||'',r.carfax_link||'']);downloadFile([h.join(','),...rows.map(r=>r.map(v=>`"${v}"`).join(','))].join('\n'),`signal_vin_results_${getTimestamp()}.csv`,'text/csv')}
function downloadFile(c,f,t){let b=new Blob([c],{type:t}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u)}
function getTimestamp(){return new Date().toISOString().replace(/[:.]/g,'-').substring(0,19)}
document.addEventListener('DOMContentLoaded',()=>document.getElementById('prefixesDisplay').textContent=getValidPrefixes().join(', '));
</script>
</body>
</html>

